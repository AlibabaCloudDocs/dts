# 创建RDS for MySQL实例间的双向数据同步 {#concept_56776_zh .concept}

[数据传输服务](https://dts.console.aliyun.com/)（Data Transmission Service，简称DTS）支持两个MySQL数据库之间的双向数据实时同步，适用于异地多活（单元化）、数据异地容灾等多种应用场景。本文以RDS for MySQL实例为例，介绍双向数据同步的配置步骤。

## 前提条件 {#section_spx_dpj_dhb .section}

-   数据同步的源RDS实例和目标RDS实例已存在，如不存在请[创建RDS实例](https://help.aliyun.com/document_detail/26117.html)。
-   源RDS实例和目标RDS实例的数据库类型为MySQL。

## 支持的同步架构 {#section_obd_dw3_dhb .section}

目前DTS仅支持两个MySQL数据库之间的双向同步，暂不支持多个MySQL数据库之间的双向同步。

![双向数据同步架构](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/17125/155547979041047_zh-CN.png)

## 支持的数据源 {#section_w5t_1w3_dhb .section}

MySQL间的双向数据同步支持以下数据源，本文以RDS for MySQL实例为数据源介绍配置流程，其他数据源的配置流程与该案例类似。

|同步源数据库|同步目的数据库|
|:-----|:------|
| -   RDS for MySQL实例
-   ECS上的自建数据库
-   通过专线/VPN网关/智能网关接入的自建数据库

 | -   RDS for MySQL实例
-   ECS上的自建数据库
-   通过专线/VPN网关/智能网关接入的自建数据库

 |

## 支持同步语法 {#section_dsz_1w3_dhb .section}

MySQL间的双向数据同步支持所有DML语法和部分DDL语法的同步，支持的DDL语法如下。

-   ALTER TABLE、ALTER VIEW、ALTER FUNCTION、ALTER PROCEDURE。
-   CREATE DATABASE、CREATE SCHEMA、CREATE INDEX、CREATE TABLE、CREATE PROCEDURE、CREATE FUNCTION、CREATE TRIGGER、CREATE VIEW、CREATE EVENT。
-   DROP FUNCTION、DROP EVENT、DROP INDEX、DROP PROCEDURE、DROP TABLE、DROP TRIGGER、DROP VIEW。
-   RENAME TABLE、TRUNCATE TABLE。

## 冲突检测 {#section_egs_bw3_dhb .section}

为保障同步数据的一致性，您需要确保同一个主键/业务主键／唯一键的记录只在双向同步的一个节点进行更新。如果发生了误操作，在两个节点均进行了更新，那么将会出现同步冲突。

DTS通过冲突检测和修复最大程度地维护双向同步实例的稳定性。目前DTS支持进行检测的冲突类型包括：

-   Insert导致的唯一性冲突

    同步Insert语句时违背了唯一性约束，例如双向同步的两个节点同时或者在极为接近的时间Insert某个主键值相同的记录，那么同步到对端时，会因为已经存在相同主键值的记录，导致Insert同步失败。

-   Update 更新的记录不完全匹配
    -   Update要更新的记录在同步目标实例中不存在时，DTS 会自动转化为Insert插入，此时可能会出现唯一键的唯一性冲突。
    -   Update要更新的记录出现主键或唯一键冲突。
-   Delete对应的记录不存在

    Delete要删除的记录在同步的目标实例中不存在。出现这种冲突时，不论配置何种冲突修复策略，DTS都会自动忽略Delete操作。


**说明：** 由于数据同步两端的系统时间可能存在差异、同步存在延时等多种因素，DTS无法完全保证冲突检测机制能够完全防止数据的冲突。在使用双向同步时，您需要在业务层面配合进行相应的改造，保证同一个主键/业务主键／唯一键的记录只在双向同步的某个节点进行更新。

## 冲突修复策略 {#section_jhm_cw3_dhb .section}

对于上述数据同步的冲突DTS提供了修复策略，您可以在配置双向同步时进行选择。

-   TaskFailed \(遇到冲突，任务报错退出\)

    默认的冲突修复策略。当数据同步遇到上述的冲突类型时，同步任务直接报错并退出，同步任务进入失败状态，需要用户介入修复任务。

-   Ignore \(遇到冲突，直接使用目标实例中的冲突记录\)

    当数据同步遇到上述的冲突类型时，直接跳过当前同步语句，继续往下执行，选择使用目标实例中的冲突记录。

-   Overwrite \(遇到冲突，直接覆盖目标实例中的冲突记录\)

    当数据同步遇到上述的冲突类型时，直接覆盖目标实例中的冲突记录。


## 功能限制 {#section_mkt_dw3_dhb .section}

-   不兼容触发器

    同步对象为整个库且这个库中包含了会更新同步表内容的触发器，那么可能导致同步数据不一致。例如数据库中存在了两个表A和B。表A上有一个触发器，触发器内容为在insert一条数据到表A之后，在表B中插入一条数据。这种情况在同步过程中，如果源实例表A上进行了Insert操作，则会导致表B在源实例跟目标实例数据不一致。

    此类情况须要将目标实例中的对应触发器删除掉，表B的数据由源实例同步过去，详情请参考[触发器存在情况下如何配置同步作业](https://help.aliyun.com/document_detail/26655.html) 。

-   rename table限制

    rename table操作可能导致同步数据不一致。例如同步对象只包含表A，如果同步过程中源实例将表A重命名为表B，那么表B将不会被同步到目标库。为避免该问题，您可以在数据同步配置时，选择同步表A和表B所在的整个数据库作为同步对象。

-   DDL语法同步方向限制

    为保障双向同步链路的稳定性，对于同一张表的DDL更新只能在其中一个同步方向进行同步。即一旦某个同步方向配置了DDL同步，则在反方向上不支持DDL同步，只进行DML同步。


## 操作步骤一 购买数据同步实例 {#section_pdn_1pj_dhb .section}

1.  登录[数据传输服务DTS控制台](https://dts.console.aliyun.com/)。
2.  在左侧导航栏，单击**数据同步**。
3.  在页面右上角，单击**创建同步作业**。
4.  在数据传输服务购买页面，选择付费类型为**预付费**或**按量付费**。
    -   预付费：属于预付费，即在新建实例时需要支付费用。适合长期需求，价格比按量付费更实惠，且购买时长越长，折扣越多。
    -   按量付费：属于后付费，即按小时扣费。适合短期需求，用完可立即释放实例，节省费用。
5.  选择数据同步实例的参数配置信息，参数说明如下表所示。

    |参数配置区|参数项|说明|
    |:----|:--|:-|
    |基本配置|功能|选择**数据同步**。|
    |源实例|选择**MySQL**。|
    |源实例地域|选择数据同步链路中源RDS实例的地域。**说明：** 订购后不支持更换地域，请谨慎选择。

|
    |目标实例|选择**MySQL**。|
    |目标实例地域|选择数据同步链路中目标RDS实例的地域。**说明：** 订购后不支持更换地域，请谨慎选择。

 |
    |同步拓扑|数据同步支持的拓扑类型，选择**双向同步**。|
    |网络类型|数据同步服务使用的网络类型，目前固定为**专线**。|
    |同步链路规格|数据传输为您提供了不同性能的链路规格，以同步的记录数为衡量标准。详情请参考[数据同步规格说明](https://help.aliyun.com/document_detail/26605.html)。|
    |购买量|购买数量|一次性购买数据同步实例的数量，默认为1，如果购买的是按量付费实例，一次最多购买 99 条链路。|

6.  单击**立即购买**，根据提示完成支付流程。

## 操作步骤二 配置双向数据同步 {#section_p1m_brj_dhb .section}

1.  登录[数据传输服务DTS控制台](https://dts.console.aliyun.com/)。
2.  在左侧导航栏，单击**数据同步**。
3.  定位至已购买的数据同步实例，单击该实例下第一个同步作业的**配置同步链路**。

    ![双向同步任务](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/17125/155547979041151_zh-CN.png)

    **说明：** 双向数据同步实例会包含两个同步作业，需要分别进行配置。

4.  配置同步通道的源实例及目标实例信息。

    ![RDS双向同步源目实例配置](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/17125/155547979041052_zh-CN.png)

    |配置项目|配置选项|配置说明|
    |:---|:---|:---|
    |任务名称|-|     -   DTS为每个任务自动生成一个任务名称，任务名称没有唯一性要求。
    -   您可以根据需要修改任务名称，建议为任务配置具有业务意义的名称，便于后续的任务识别。
 |
    |源实例信息|实例类型|选择**RDS实例**。|
    |实例地区|购买数据同步实例时选择的源实例地域信息，不可变更。|
    |实例ID|选择作为数据同步源的RDS实例ID。|
    |数据库账号|填入源RDS的数据库账号。**说明：** 当源RDS实例的数据库类型为**MySQL 5.5**或**MySQL 5.6**时，没有**数据库账号**和**数据库密码**配置选项。

|
    |数据库密码|填入数据库账号对应的密码。|
    |连接方式|根据需求选择**非加密连接**或**SSL安全连接**，本案例选择为**非加密连接**。**说明：** 选择 **SSL安全连接**时，需要提前开启RDS实例的SSL加密功能，详情请参考[设置SSL加密](https://help.aliyun.com/document_detail/96120.html)。

|
    |目标实例信息|实例类型|选择**RDS实例**。|
    |实例地区|购买数据同步实例时选择的目标实例地域信息，不可变更。|
    |实例ID|选择作为数据同步目标的RDS实例ID。|
    |数据库账号|填入目标RDS的数据库账号。**说明：** 当目标RDS实例的数据库类型为**MySQL 5.5**或**MySQL 5.6**时，没有**数据库账号**和**数据库密码**配置选项。

|
    |数据库密码|填入数据库账号对应的密码。|
    |连接方式|根据需求选择**非加密连接**或**SSL安全连接**，本案例选择为**非加密连接**。**说明：** 选择 **SSL安全连接**时，需要提前开启RDS实例的SSL加密功能，详情请参考[设置SSL加密](https://help.aliyun.com/document_detail/96120.html)。

|

5.  单击页面右下角的**授权白名单并进入下一步**。
6.  配置同步策略及对象信息。

    ![RDS双向同步对象及策略配置](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/17125/155547979041053_zh-CN.png)

    |配置项目|配置选项|配置说明|
    |:---|:---|:---|
    |同步策略配置|是否过滤DDL|     -   选择为**是**：不同步DDL操作。
    -   选择为**否**：同步DDL操作。

**说明：** 一旦该同步方向选择同步DDL操作，那么同一张表在另一个同步方向则不支持同步DDL操作。

 |
    |DML同步类型|定义需要同步的DML类型，默认为**Insert**、**Update**、**Delete**，您可以根据业务需求调整同步的DML类型。|
    |冲突修复策略|定义同步冲突的修复策略，默认为**TaskFailed**，您可以根据业务情况选择合适的冲突修复策略，详情请参考[冲突修复策略](#section_jhm_cw3_dhb)。|
    |选择同步对象|-| 同步对象的选择粒度为库、表。

 **说明：** 

    -   如果选择整个库作为同步对象，那么该库中所有对象的结构变更操作都会同步至目标库。
    -   如果选择某个表作为同步对象，那么只有这个表的drop/alter/truncate/rename table、create/drop index操作会同步至目标库。
 |

7.  上述配置完成后单击页面右下角的**下一步**。
8.  配置同步初始化的高级配置信息。

    ![数据同步高级设置](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/17125/155547979041055_zh-CN.png)

    -   此步骤会将源实例中已经存在同步对象的结构及数据在目标实例中初始化，作为后续增量同步数据的基线数据。
    -   同步初始化类型细分为：结构初始化，全量数据初始化。默认情况下，需要选择**结构初始化**和**全量数据初始化**。
    **说明：** 如果同步对象中有部分表包含在另外一个同步方向的同步对象中，那么这部分表不会进行同步初始化。

9.  上述配置完成后，单击页面右下角的**预检查并启动**。

    **说明：** 

    -   在数据同步任务正式启动之前，会先进行预检查。只有预检查通过后，才能成功启动数据同步任务。
    -   如果预检查失败，单击具体检查项后的![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/17125/155547979041056_zh-CN.png)，查看具体的失败详情。根据失败原因修复后，重新进行预检查。
10. 在预检查对话框中显示**预检查通过**后，关闭预检查对话框，该同步作业的同步任务正式开始。
11. 等待该同步作业的链路初始化完成，直至状态处于**同步中**。

    您可以在 数据同步页面，查看数据同步状态。

12. 定位至第二个同步作业，单击**配置同步链路**，配置流程参考参考[步骤4](#step4)~10。

    ![配置反向数据同步](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/17125/155547979041152_zh-CN.png)

13. 第二个同步作业配置完成后，等待两个同步作业的链路状态均处于**同步中**，即完成双向数据同步的配置流程。

    ![双向数据同步状态](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/17125/155547979041154_zh-CN.png)


