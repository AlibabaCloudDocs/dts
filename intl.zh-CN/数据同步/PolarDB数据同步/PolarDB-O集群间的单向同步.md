# PolarDB-O集群间的单向同步

PolarDB是阿里云自研的下一代关系型云数据库，有三个独立的引擎，分别可以100%兼容MySQL、100%兼容PostgreSQL、高度兼容Oracle语法，适用于企业多样化的数据库应用场景。通过数据传输服务DTS（Data Transmission Service），您可以实现PolarDB-O集群间的单向数据同步。

-   源PolarDB-O集群需为最新版本，升级方式详情请见[小版本升级]()。
-   源PolarDB-O集群中，待同步的表需具备主键或非空唯一索引。
-   源PolarDB-O集群中，wal\_level参数的值需设置为logical，即在预写式日志WAL（Write-ahead logging）中增加支持逻辑编码所需的信息。详情请参见[设置集群参数]()。

## 注意事项

-   DTS在执行全量数据初始化时将占用源库和目标库一定的读写资源，可能会导致数据库的负载上升，在数据库性能较差、规格较低或业务量较大的情况下（例如源库有大量慢SQL、存在无主键表或目标库存在死锁等），可能会加重数据库压力，甚至导致数据库服务不可用。因此您需要在执行数据同步前评估源库和目标库的性能，同时建议您在业务低峰期执行数据同步（例如源库和目标库的CPU负载在30%以下）。
-   一个数据同步作业只能同步一个数据库，如有多个数据库需要同步，您需要为每个数据库配置数据同步作业。
-   为保障同步延迟时间展示的准确性，DTS会在源库中新增一个表，表名为`dts_postgres_heartbeat`，结构及内容如下图所示。

    ![表结构](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/3920649951/p94992.png)

-   在数据同步过程中，如果同步对象的选择粒度为Schema，在待同步的Schema中创建了新的表或使用RENAME命令重建了待同步的表，您需要在对该表写入数据前执行`ALTER TABLE schema.table REPLICA IDENTITY FULL;`命令。

    **说明：** 将上述命令中的`schema`和`table`替换成真实的Schema名和表名。


## 支持同步的SQL操作

INSERT、UPDATE、DELETE

## 操作步骤

1.  购买数据同步作业，详情请参见[购买流程](/intl.zh-CN/快速入门/购买流程.md)。

    **说明：** 购买时，源实例和目标实例均选择为**POLARDB**，并选择同步拓扑为**单向同步**。

2.  登录[数据传输控制台](https://dts-intl.console.aliyun.com/)。

3.  在左侧导航栏，单击**数据同步**。

4.  在同步作业列表页面顶部，选择同步的目标实例所属地域。

    ![选择地域](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/7349459951/p50604.png)

5.  定位至已购买的数据同步实例，单击**配置同步链路**。

6.  配置同步通道的源实例及目标实例信息。

    ![配置源和目标实例信息](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1920649951/p98209.png)

    |类别|配置|说明|
    |:-|:-|:-|
    |无|同步作业名称|DTS会自动生成一个同步作业名称，建议配置具有业务意义的名称（无唯一性要求），便于后续识别。|
    |源实例信息|实例类型|固定为**PolarDB实例**，不可变更。|
    |实例地区|购买数据同步实例时选择的源实例地域信息，不可变更。|
    |PolarDB实例ID|选择源PolarDB集群ID。|
    |数据库名称|填入待同步的数据库名称。|
    |数据库账号|填入源PolarDB集群的高权限账号。数据库账号创建方法请参见[创建数据库账号]()。|
    |数据库密码|填入数据库账号对应的密码。|
    |目标实例信息|实例类型|固定为**PolarDB**，不可变更。|
    |实例地区|购买数据同步实例时选择的目标实例地域信息，不可变更。|
    |PolarDB实例ID|选择目标PolarDB集群ID。|
    |数据库名称|填入同步的目标数据库名称。|
    |数据库账号|填入目标PolarDB集群的数据库账号，该账号需具备**数据库Owner**权限。 **说明：** **数据库Owner**在创建数据库时已指定。 |
    |数据库密码|填入数据库账号对应的密码。|

7.  单击页面右下角的**授权白名单并进入下一步**。

    **说明：** 此步骤会将DTS服务器的IP地址自动添加到源和目标PolarDB集群的白名单中，用于保障DTS服务器能够正常连接源和目标集群。

8.  配置目标已存在表的处理模式和同步对象。

    ![选择同步对象](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1920649951/p98211.png)

    |配置项目|配置说明|
    |:---|:---|
    |目标已存在表的处理模式|    -   **预检查并报错拦截**：检查目标数据库中是否有同名的表。如果目标数据库中没有同名的表，则通过该检查项目；如果目标数据库中有同名的表，则在预检查阶段提示错误，数据同步作业不会被启动。

**说明：** 如果目标库中同名的表不方便删除或重命名，您可以[设置同步对象在目标实例中的名称](/intl.zh-CN/数据同步/同步作业管理/设置同步对象在目标实例中的名称.md)来避免表名冲突。

    -   **忽略报错并继续执行**：跳过目标数据库中是否有同名表的检查项。

**警告：** 选择为**忽略报错并继续执行**，可能导致数据不一致，给业务带来风险，例如：

        -   表结构一致的情况下，如果在目标库遇到与源库主键的值相同的记录，在初始化阶段会保留目标库中的该条记录；在增量同步阶段则会覆盖目标库的该条记录。
        -   表结构不一致的情况下，可能会导致无法初始化数据、只能同步部分列的数据或同步失败。 |
    |选择同步对象|在源库对象框中单击待同步的对象，然后单击![向右小箭头](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/8502659951/p40698.png)图标将其移动至已选择对象框。

同步对象的选择粒度为库、表。

**说明：**

    -   如果选择整个库作为同步对象，那么该库中所有对象的结构变更操作都会同步至目标库。
    -   默认情况下，同步对象的名称保持不变。如果您需要改变同步对象在目标集群中的名称，请使用对象名映射功能，详情请参见[设置同步对象在目标实例中的名称](/intl.zh-CN/数据同步/同步作业管理/设置同步对象在目标实例中的名称.md)。 |

9.  上述配置完成后，单击页面右下角的**下一步**。

10. 配置同步初始化。

    ![配置同步初始化](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1920649951/p98213.png)

    |初始化类型|说明|
    |-----|--|
    |结构初始化|DTS将同步对象的结构定义同步到目标PolarDB集群。目前支持的对象包括：表、视图、同义词、触发器、存储过程、存储函数、包、自定义类型。 **说明：** 当同步对象包含触发器时可能导致数据不一致，解决方案请参见[源库存在触发器时如何配置同步作业](/intl.zh-CN/最佳实践/源库存在触发器时如何配置同步作业.md)。 |
    |全量数据初始化|DTS会将源库中同步对象的存量数据，全部同步至目标PolarDB集群。 **说明：** 在结构初始化和全量数据初始化完成之前，请勿对同步对象执行DDL操作，否则可能导致同步失败。 |

11. 上述配置完成后，单击页面右下角的**预检查并启动**。

    **说明：**

    -   在数据同步作业正式启动之前，会先进行预检查。只有预检查通过后，才能成功启动数据同步作业。
    -   如果预检查失败，单击具体检查项后的![提示](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/8502659951/p47468.png)图标，查看失败详情。根据提示修复后，重新进行预检查。
12. 在预检查对话框中显示**预检查通过**后，关闭预检查对话框，同步作业将正式开始。

13. 等待同步作业的链路初始化完成，直至处于**同步中**状态。

    您可以在数据同步页面，查看数据同步作业的状态。

    ![查看同步作业状态](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/1349459951/p41059.png)


